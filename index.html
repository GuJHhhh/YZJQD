<!DOCTYPE html>

<html lang="zh-CN">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>云之家签到</title>

    <style>

        :root {

            --primary-color: #4A90E2;

            --primary-hover: #357ABD;

            --success-color: #52c41a;

            --error-color: #f5222d;

            --border-radius: 12px;

            --box-shadow: 0 8px 24px rgba(0,0,0,0.08);

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

        }



        * {

            margin: 0;

            padding: 0;

            box-sizing: border-box;

        }



        body {

            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;

            margin: 0;

            padding: 16px;

            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ed 100%);

            min-height: 100vh;

            display: flex;

            align-items: center;

            justify-content: center;

        }



        .container {

            width: 100%;

            max-width: 420px;

            margin: 20px auto;

            background: white;

            padding: 32px 24px;

            border-radius: var(--border-radius);

            box-shadow: var(--box-shadow);

        }



        h1 {

            text-align: center;

            color: #1A1A1A;

            margin-bottom: 36px;

            font-size: 28px;

            font-weight: 600;

            letter-spacing: -0.5px;

        }



        .form-group {

            margin-bottom: 28px;

        }



        label {

            display: block;

            margin-bottom: 10px;

            color: #4A4A4A;

            font-size: 15px;

            font-weight: 500;

            letter-spacing: -0.2px;

        }



        select, input {

            width: 100%;

            padding: 14px 16px;

            border: 2px solid #E8E8E8;

            border-radius: var(--border-radius);

            font-size: 16px;

            background-color: #FAFAFA;

            color: #2C2C2C;

            transition: var(--transition);

            -webkit-appearance: none;

            appearance: none;

        }



        select {

            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%234A4A4A' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");

            background-repeat: no-repeat;

            background-position: right 16px center;

            padding-right: 40px;

        }



        select:hover, input:hover {

            border-color: var(--primary-color);

            background-color: #FFFFFF;

        }



        select:focus, input:focus {

            outline: none;

            border-color: var(--primary-color);

            background-color: #FFFFFF;

            box-shadow: 0 0 0 3px rgba(74,144,226,0.1);

        }



        button {

            width: 100%;

            padding: 16px 20px;

            background-color: var(--primary-color);

            color: white;

            border: none;

            border-radius: var(--border-radius);

            font-size: 16px;

            font-weight: 600;

            cursor: pointer;

            transition: var(--transition);

            display: flex;

            align-items: center;

            justify-content: center;

            letter-spacing: 0.3px;

        }



        button:hover {

            background-color: var(--primary-hover);

            transform: translateY(-1px);

        }



        button:active {

            transform: translateY(0);

        }



        button.loading {

            opacity: 0.8;

            cursor: not-allowed;

        }



        .success-message {

            display: none;

            text-align: center;

            margin-top: 20px;

            padding: 14px;

            border-radius: var(--border-radius);

            font-size: 15px;

            font-weight: 500;

            animation: slideUp 0.3s ease;

            transition: var(--transition);

        }



        .success-message.success {

            background-color: #F0FFF0;

            border: 2px solid #B7EB8F;

            color: var(--success-color);

        }



        .success-message.error {

            background-color: #FFF1F0;

            border: 2px solid #FFCCC7;

            color: var(--error-color);

        }



        @keyframes slideUp {

            from {

                opacity: 0;

                transform: translateY(10px);

            }

            to {

                opacity: 1;

                transform: translateY(0);

            }

        }



        .loading-spinner {

            display: none;

            width: 20px;

            height: 20px;

            margin-right: 10px;

            border: 2px solid rgba(255,255,255,0.3);

            border-top: 2px solid #FFFFFF;

            border-radius: 50%;

            animation: spin 0.8s linear infinite;

        }



        @keyframes spin {

            0% { transform: rotate(0deg); }

            100% { transform: rotate(360deg); }

        }



        button.loading .loading-spinner {

            display: inline-block;

        }



        @media (max-width: 480px) {

            body {

                padding: 12px;

            }

            

            .container {

                padding: 24px 20px;

            }



            h1 {

                font-size: 24px;

                margin-bottom: 28px;

            }



            .form-group {

                margin-bottom: 24px;

            }



            select, input {

                padding: 12px 14px;

                font-size: 15px;

            }



            button {

                padding: 14px 20px;

                font-size: 15px;

            }

        }

    </style>

</head>

<body>

    <div class="container">

        <h1>云之家签到</h1>

        <form id="signInForm">

            <div class="form-group">

                <label for="employee">选择员工</label>

                <select id="employee" required>

                    <option value="">请选择员工</option>

                    <option value="64e3fc13e4b0c52c7eea5db1">顾剑寒</option>

                    <option value="5d423259e4b013deb9e51cf5">杨林峰</option>

                    <option value="573eb94be4b07ae9d3cd90b1">陈彬</option>

                    <option value="573eb774e4b05a288ba319af">周克华</option>

                    <option value="5e7c3b31e4b08f0a5474cad9">杨贤宇</option>

                    <option value="5ef075ebe4b0b29f282a6bc3">蒋剑杰</option>

                    <option value="628439a1e4b0bdd0af2c7150">陈中晔</option>

                    <option value="63fe96a5e4b0309e43659f76">吴仁杰</option>

                    <option value="5b0533b1e4b076e4e85653fd">施思</option>

                </select>

            </div>



            <div class="form-group">

                <label for="datetime">签到时间</label>

                <input type="datetime-local" id="datetime" required step="1">

            </div>



            <button type="submit" id="submitBtn">

                <span class="loading-spinner"></span>

                <span class="button-text">签到</span>

            </button>

        </form>

        <div id="successMessage" class="success-message"></div>

    </div>



    <script>

        // 页面加载时设置默认时间为当前时间

        document.addEventListener('DOMContentLoaded', function() {

            const now = new Date();

            now.setSeconds(now.getSeconds());

            const datetime = now.toISOString().slice(0, 19);

            document.getElementById('datetime').value = datetime;

        });



        // 获取token的函数

        async function getToken() {

            const timestamp = Date.now(); // 获取13位时间戳

            const formData = new URLSearchParams();

            formData.append('eid', '518516');

            formData.append('secret', 'UyQTKsPEKnWhzeLqHX60CG00Yx08RZ5k');

            formData.append('timestamp', timestamp);

            formData.append('scope', 'resGroupSecret');



            try {

                const response = await fetch('https://www.yunzhijia.com/gateway/oauth2/token/getAccessToken', {

                    method: 'POST',

                    headers: {

                        'Content-Type': 'application/x-www-form-urlencoded'

                    },

                    body: formData

                });



                const data = await response.json();

                console.log('Token API 响应:', data); // 添加这行来查看完整响应



                if (data.success && data.data && data.data.accessToken) {

                    return data.data.accessToken;

                } else {

                    throw new Error(data.error || '获取token失败');

                }

            } catch (error) {

                console.error('获取token错误:', error);

                throw error;

            }

        }



        // 获取位置信息的函数

        async function getUserPosition(token, openId) {

            try {

                const response = await fetch(`https://www.yunzhijia.com/gateway/attendance-data/v1/attSet/getUserPositionList?accessToken=${token}`, {

                    method: 'POST',

                    headers: {

                        'Content-Type': 'application/json'

                    },

                    body: JSON.stringify({

                        "openId": openId

                    })

                });



                const data = await response.json();

                console.log('位置信息响应:', data);



                if (data.success && data.data && data.data.attSets && data.data.attSets.length > 0) {

                    return data.data.attSets[0].positionId; // 返回第一个位置的ID

                } else {

                    throw new Error(data.errorMsg || '获取位置信息失败');

                }

            } catch (error) {

                console.error('获取位置信息错误:', error);

                throw error;

            }

        }



        // 签到函数

        async function clockIn(token, openId, positionId, datetime) {

            try {

                // 将datetime转换为13位时间戳

                const clockInTime = new Date(datetime).getTime();



                const response = await fetch(`https://www.yunzhijia.com/gateway/attendance-data/v1/clockIn/singleUpload?accessToken=${token}`, {

                    method: 'POST',

                    headers: {

                        'Content-Type': 'application/json'

                    },

                    body: JSON.stringify({

                        "openId": openId,

                        "clockType": 1,

                        "clockInTime": clockInTime,

                        "positionId": positionId,

                        "remark": ""

                    })

                });



                const data = await response.json();

                console.log('签到响应:', data);



                if (data.success) {

                    return true;

                } else {

                    throw new Error(data.error || '签到失败');

                }

            } catch (error) {

                console.error('签到错误:', error);

                throw error;

            }

        }



        // 修改表单提交处理部分

        document.getElementById('signInForm').addEventListener('submit', async function(e) {

            e.preventDefault();

            

            const employee = document.getElementById('employee').value;

            const datetime = document.getElementById('datetime').value;

            const successMessage = document.getElementById('successMessage');

            const submitBtn = document.getElementById('submitBtn');

            

            // 添加加载状态

            submitBtn.classList.add('loading');

            submitBtn.disabled = true;



            try {

                // 获取token

                const token = await getToken();

                console.log('获取到的token:', token);



                // 获取位置信息

                const positionId = await getUserPosition(token, employee);

                console.log('获取到的位置ID:', positionId);



                // 执行签到

                const clockInResult = await clockIn(token, employee, positionId, datetime);

                

                // 显示成功消息

                successMessage.textContent = '签到成功！';

                successMessage.className = 'success-message success';

                successMessage.style.display = 'block';



            } catch (error) {

                // 显示错误消息

                successMessage.textContent = '签到失败：' + error.message;

                successMessage.className = 'success-message error';

                successMessage.style.display = 'block';

            } finally {

                // 移除加载状态

                submitBtn.classList.remove('loading');

                submitBtn.disabled = false;

                

                // 3秒后隐藏消息

                setTimeout(() => {

                    successMessage.style.display = 'none';

                }, 3000);

            }

        });

    </script>

</body>

</html> 
